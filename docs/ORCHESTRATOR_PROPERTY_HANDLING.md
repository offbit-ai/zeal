# Orchestrator Agent Property Handling

## Overview

The orchestrator agent has been enhanced to intelligently handle complex property types including `dataOperations` and `rules` when configuring nodes during workflow creation.

## Supported Property Types

### 1. DataOperations Properties

For properties with type `dataOperations`, the agent can now generate:

- **Map Operations**: Transform field names and values using JavaScript expressions
- **Filter Operations**: Remove items based on conditions  
- **Sort Operations**: Order data by field values
- **Transform Operations**: Apply custom transformations
- **Group Operations**: Group items by field values
- **Aggregate Operations**: Calculate summary values (sum, avg, count, min, max, etc.)
- **Merge/Split Operations**: Combine or split data sources

#### Expression Syntax

The agent uses JavaScript template literals with the following pattern:
- Access input data: `input.get('portName').data`
- Access nested fields: `${input.get('data').data.fieldName}`
- Transformations: `${input.get('data').data.price} * 1.2`

#### Example DataOperation Generated by Agent

```json
{
  "dataTransform": {
    "value": [
      {
        "id": "set-123",
        "name": "Data Pipeline",  // REQUIRED field
        "operations": [
          {
            "id": "op-456",
            "type": "map",
            "enabled": true,
            "description": "Transform price to total with tax",
            "mapping": [
              {
                "sourceField": "${input.get('data').data.price}",
                "targetField": "totalPrice",
                "transform": "${input.get('data').data.price} * 1.08"  // Optional transform
              }
            ]
          },
          {
            "id": "op-789",
            "type": "filter",
            "enabled": true,
            "description": "Keep only active items",
            "filterExpression": "${input.get('data').data.status} === 'active'"
          },
          {
            "id": "op-790",
            "type": "sort",
            "enabled": true,
            "description": "Sort by date",
            "sortField": "${input.get('data').data.createdAt}",
            "sortDirection": "desc"
          },
          {
            "id": "op-791",
            "type": "aggregate",
            "enabled": true,
            "description": "Sum total amounts",
            "aggregateField": "${input.get('data').data.amount}",
            "aggregateFunction": "sum"
          }
        ]
      }
    ]
  }
}
```

### 2. Rules Properties

For properties with type `rules`, the agent can generate:

- Conditional rule sets with IF/THEN logic
- Rule groups with AND/OR connectors
- Support for all comparison operators (is, is_not, contains, greater_than, less_than, etc.)
- JavaScript expressions for dynamic field values

#### Example Rule Generated by Agent

```json
{
  "decisionRules": {
    "value": [
      {
        "id": "ruleset-001",
        "type": "IF",  // Can be "IF" or "OR"
        "groups": [
          {
            "id": "group-001",
            "connector": "AND",  // Can be "AND" or "OR"
            "rules": [
              {
                "id": "rule-001",
                "field": "${input.get('data').data.status}",
                "operator": "is",
                "value": "active",
                "valueType": "string"  // Can be "string", "number", "date", or "boolean"
              },
              {
                "id": "rule-002", 
                "field": "${input.get('data').data.amount}",
                "operator": "greater_than",
                "value": "100",
                "valueType": "number"
              }
            ]
          }
        ]
      }
    ]
  }
}
```

## Property Value Propagation

### Real-time Updates in Embed Mode

The system now properly propagates property updates from the orchestrator to embedded workflow views:

1. **Orchestrator Updates**: When the orchestrator updates node properties via `/api/orchestrator/nodes/properties`, it uses `ServerCRDTOperations.updateNodeProperties`

2. **CRDT Broadcasting**: The server broadcasts updates with type `node-updated` containing the property values

3. **Embed Polling**: The embed page polls for updates via `/api/orchestrator/crdt-updates` using the `useCRDTPolling` hook

4. **Store Updates**: The workflow store's `updateNodeProperty` method now updates both:
   - `propertyValues` at the Y.Node level
   - `metadata.propertyValues` for UI components

5. **UI Reflection**: WorkflowNode components read from `metadata.propertyValues` and immediately reflect changes

## Implementation Details

### Agent Enhancement (lib/orchestrator/agent.ts)

The `mapNodeProperties` method was enhanced to:

1. Identify dataOperations and rules properties separately
2. Build connection context for understanding available input ports
3. Generate appropriate prompt instructions for each property type
4. Process LLM responses and structure them correctly with unique IDs
5. Handle both array and single-value formats

### Store Enhancement (store/workflow-store.ts)

The `updateNodeProperty` method now:

1. Updates `propertyValues` at the node level
2. Also updates `metadata.propertyValues` to ensure UI reflects changes
3. Triggers proper re-renders through `setGraphDirty`

### CRDT Polling Enhancement (hooks/useCRDTPolling.ts)

The polling hook now:

1. Applies property updates individually
2. Forces re-render after property updates
3. Handles both position and property updates in `node-updated` events

## Usage by Node Templates

Node templates can declare these properties in their metadata:

```typescript
// For dataOperations
properties: {
  dataOperations: {
    type: 'dataOperations',
    availableFields: ['id', 'name', 'status', 'amount'],
    description: 'Configure data transformation pipeline'
  }
}

// For rules
properties: {
  decisionRules: {
    type: 'rules',
    availableFields: ['value', 'count', 'status', 'type'],
    availableOperators: ['is', 'is_not', 'contains', 'greater_than'],
    description: 'Define conditional rules'
  }
}
```

## Benefits

1. **Intelligent Configuration**: The agent can automatically configure complex data transformations and conditional logic based on workflow context

2. **Real-time Sync**: Property updates from the orchestrator are immediately reflected in embedded workflow views

3. **JavaScript Expression Support**: Both dataOperations and rules support dynamic JavaScript expressions for accessing input data

4. **Type Safety**: Proper handling of different property types with automatic ID generation and structure validation

5. **Seamless Integration**: Works with existing node templates and property panel UI components

## Testing

A test script (`test-property-propagation.js`) is available to verify:
- Property updates via orchestrator API
- CRDT broadcast of updates
- Proper polling and application of updates

Run with: `node test-property-propagation.js`